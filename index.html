<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Nagios by rafaelbm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Nagios</h1>
      <h2 class="project-tagline">Trabalho para o tio Lu sobre o Nagios</h2>
      <a href="https://github.com/rafaelbm/Nagios" class="btn">View on GitHub</a>
      <a href="https://github.com/rafaelbm/Nagios/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/rafaelbm/Nagios/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="instalando-nagios-411" class="anchor" href="#instalando-nagios-411" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instalando Nagios 4.1.1</h1>

<p>Tutorial baseado no seguinte <a href="http://www.unixmen.com/how-to-install-nagios-core-4-1-1-in-ubuntu-15-10/">post</a>.</p>

<p>Outros posts que foram úteis:  </p>

<ul>
<li><a href="https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/eventhandlers.html">https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/eventhandlers.html</a></li>
<li><a href="https://thiagolucas.wordpress.com/2014/03/28/nagios-debian-instalacao-detalhada/">https://thiagolucas.wordpress.com/2014/03/28/nagios-debian-instalacao-detalhada/</a></li>
</ul>

<blockquote>
<p>Nagios é sistema, que pode ser usado para monitoramento de infraestrutura de rede. Usando Nagios, podemos monitorar servidores, switches, aplicações e serviços etc. Alertar o administrador do sistema quando algo der errado e também alertar quando esses erros forem corrigidos.</p>
</blockquote>

<h2>
<a id="principais-funcionalidades" class="anchor" href="#principais-funcionalidades" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Principais funcionalidades</h2>

<ul>
<li>Monitorar toda sua infraestrutura de TI.</li>
<li>Saber imediatamente quando problemas surgirem</li>
<li>Compartilhar dados de disponibilidade com as partes interessadas</li>
<li>Detectar violações de segurança</li>
<li>Planos e orçamento para atualizações na infraestrutura de TI.</li>
<li>Reduza as perdas de tempo de inatividade e negócios.</li>
</ul>

<h2>
<a id="pré-requisitos" class="anchor" href="#pr%C3%A9-requisitos" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Pré-requisitos</h2>

<p><strong>Para facilitar os passos a seguir execute-os em modo <em>root</em>.</strong></p>

<p>Atualizar o servidor</p>

<pre><code>apt-get update  
apt-get upgrade 
</code></pre>

<p>Instale as dependências do nagios</p>

<pre><code>apt-get install libgd2-xpm-dev libsnmp-perl libssl-dev openssl build-essential apache2 libapache2-mod-php5 unzip
</code></pre>

<p>Crie um novo usuário do <strong><em>nagios</em></strong></p>

<pre><code>useradd -m nagios
passwd nagios
</code></pre>

<p>Crie um novo grupo de usuários <strong><em>nagcmd</em></strong> para permitir que comandos externos sejam enviados através da interface web. Adicione o usuário nagios e o usuário do apache ao grupo.</p>

<pre><code>groupadd nagcmd
usermod -a -G nagcmd nagios
usermod -a -G nagcmd www-data   
</code></pre>

<h2>
<a id="baixar-o-nagios-e-plugins" class="anchor" href="#baixar-o-nagios-e-plugins" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Baixar o Nagios e Plugins</h2>

<p>Crie um diretório para armazenar os downloads</p>

<pre><code>mkdir /usr/src/nagios
cd /usr/src/nagios
</code></pre>

<p>Vá para a página do <a href="https://www.nagios.org/downloads/nagios-core/thanks/?t=1466426447">Nagios</a> para obter a versão mais recente, a versão mais recente durante a escrita desse documento é a 4.1.1</p>

<pre><code>wget https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.1.1.tar.gz
</code></pre>

<p>E baixe também os <a href="https://www.nagios.org/downloads/nagios-plugins/">plugins</a> do nagios</p>

<pre><code>wget http://www.nagios-plugins.org/download/nagios-plugins-2.1.1.tar.gz
</code></pre>

<p>Caso algum erro relacionado a certificados ocorra durante a executação do <strong>wget</strong>, execute utilizando o parâmetro <strong>--no-check-certificate</strong></p>

<pre><code>wget --no-check-certificate link
</code></pre>

<h2>
<a id="instalar-nagios-e-plugins" class="anchor" href="#instalar-nagios-e-plugins" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instalar Nagios e Plugins</h2>

<h3>
<a id="instalar-nagios" class="anchor" href="#instalar-nagios" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instalar Nagios</h3>

<p>Va até a pasta onde baixou o nagios e extraia os arquivos:</p>

<pre><code>tar xzf nagios-4.1.1.tar.gz
</code></pre>

<p>Acesse o diretório extraído:</p>

<pre><code>cd nagios-4.1.1/
</code></pre>

<p>Execute os seguintes comandos um a um para compilar e instalar o nagios.</p>

<pre><code>./configure --with-command-group=nagcmd
make all
make install
make install-init
make install-config
make install-commandmode
</code></pre>

<h3>
<a id="instalar-a-interface-web-do-nagios" class="anchor" href="#instalar-a-interface-web-do-nagios" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instalar a interface web do Nagios</h3>

<p>Execute o seguinte comando para compilar e instalar a interface web.</p>

<pre><code>make install-webconf
</code></pre>

<p>Caso o seguinte erro ocorra: </p>

<blockquote>
<p>/usr/bin/install -c -m 644 sample-config/httpd.conf /etc/httpd/conf.d/nagios.conf
/usr/bin/install: cannot create regular file ‘/etc/httpd/conf.d/nagios.conf’: No such file or directory
Makefile:296: recipe for target 'install-webconf' failed
make: *** [install-webconf] Error 1</p>
</blockquote>

<p>A mensagem de erro acima descreve que o nagios está tentando criar o arquivo <strong>nagios.conf</strong> dentro do diretório <strong>/etc/httpd.conf/</strong>. Mas em sistemas derivados do Ubuntu o <strong>nagios.conf</strong> deve ser colocado no diretório /etc/apache2/sites-enabled/</p>

<p>Para tal, execute o seguinte comando no lugar do <strong>make install-webconf</strong>.</p>

<pre><code>/usr/bin/install -c -m 644 sample-config/httpd.conf /etc/apache2/sites-enabled/nagios.conf
</code></pre>

<p>Verifique se o <strong>nagios.conf</strong> está no diretório /etc/apache2/sites-enabled.</p>

<pre><code>ls -l /etc/apache2/sites-enabled/
</code></pre>

<p>O output desse comando deve ser semelhante a:</p>

<blockquote>
<p>total 4<br>
lrwxrwxrwx 1 root root 35 Nov 28 16:49 000-default.conf -../sites-available/000-default.conf<br>
-rw-r--r-- 1 root root 1679 Nov 28 17:02 nagios.conf </p>
</blockquote>

<p>Crie uma conta <strong><em>nagiosadmin</em></strong> para a autenticação na interface web do Nagios. <strong>Lembre da senha que você definir</strong>, ela será utilizada para logar na interface web.</p>

<pre><code>htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
</code></pre>

<p>Reinicie o Apache para que as novas configurações tenham efeito.</p>

<pre><code>service apache2 restart
</code></pre>

<h3>
<a id="instalar-nagios-plugins" class="anchor" href="#instalar-nagios-plugins" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instalar Nagios Plugins</h3>

<p>Va para o diretório (provavelmente o <strong>/usr/src/nagios</strong>) onde você baixou o nagios plugins, e extraia os arquivos </p>

<pre><code>tar xzf nagios-plugins-2.1.1.tar.gz
</code></pre>

<p>Acesse o diretório extraído:</p>

<pre><code>cd nagios-plugins-2.1.1/
</code></pre>

<p>Execute os seguintes comandos um a um para compilar e instalar.</p>

<pre><code>./configure --with-nagios-user=nagios --with-nagios-group=nagios
make
make install
</code></pre>

<h2>
<a id="configurar-o-nagios" class="anchor" href="#configurar-o-nagios" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configurar o nagios</h2>

<p>Os arquivos com configurações de exemplo do Nagios estão localizados no diretório <strong>/usr/local/nagios/etc</strong>.Esses arquivos de exemplo devem funcionar bem para uma introdução ao Nagios. No entando, se você quiser, precisará colocar o seu ID e e-mail para receber alertas.</p>

<p>Para tal, edite o arquivo de configuração <strong>/usr/local/nagios/etc/objects/contacts.cfg</strong> e altere o e-mail associado ao contato <em>nagiosadmin</em>. Este e-mail será onde os alertas serão enviados</p>

<pre><code>nano /usr/local/nagios/etc/objects/contacts.cfg
</code></pre>

<p>Encontre a linha a seguir e informe o seu e-mail:</p>

<pre><code> [...]  
 define contact {  
 contact_name                    nagiosadmin             ; Short name of user  
 use                             generic-contact         ; Inherit default values from generic-contact template (defined above)    
 alias                           Nagios Admin            ; Full name of user   
 email                           seuemailaqui.com        ; &lt;&lt;CHANGE THIS TO YOUR EMAIL ADDRESS
 }  
 [...]
</code></pre>

<p>Salve e feche o arquivo.</p>



<p>Habilitar os módulos do Apache e reconfiguração e cgi</p>

<pre><code>a2enmod rewrite
a2enmod cgi
</code></pre>

<p>Reiniciar o serviço Apache</p>

<pre><code>service apache2 restart
</code></pre>

<p>Verifique se o arquivo <strong>nagios.cfg</strong> contém algum erro de sintaxe:</p>

<pre><code>/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</code></pre>

<p>Caso o comando acima não tenha apontado erros, podemos iniciar o serviço nagios: </p>

<pre><code>service nagios start
</code></pre>

<p>Nas versões mais recentes do Ubuntu/Debian é possível que o comando acima lance o seguinte erro:</p>

<pre><code>Failed to start nagios.service: Unit nagios.service failed to load: No such file or directory.
</code></pre>

<p>Para corrigir esse erro é necessário copiar o arquivo <strong>/etc/init.d/skeleton</strong> para <strong>/etc/init.d/nagios</strong> utilizando o seguinte comando:</p>

<pre><code>cp /etc/init.d/skeleton /etc/init.d/nagios
</code></pre>

<p>Edite o arquivo <strong>/etc/init.d/nagios</strong></p>

<pre><code>nano /etc/init.d/nagios
</code></pre>

<p>Adicione as seguintes linhas:</p>

<pre><code>DESC="Nagios"
NAME=nagios
DAEMON=/usr/local/nagios/bin/$NAME
DAEMON_ARGS="-d /usr/local/nagios/etc/nagios.cfg"
PIDFILE=/usr/local/nagios/var/$NAME.lock
</code></pre>

<p>Salve e feche o arquivo.</p>

<p>É necessário alterar as permissões do arquivo.</p>

<pre><code>chmod +x /etc/init.d/nagios
</code></pre>

<p>Agora é possível iniciar o serviço nagios utilizando o comando:</p>

<pre><code>/etc/init.d/nagios start 
</code></pre>

<h2>
<a id="acessar-a-interface-web-do-nagios" class="anchor" href="#acessar-a-interface-web-do-nagios" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Acessar a interface web do Nagios</h2>

<p>Abra seu navegador da web e navegue até <strong>http://{ip-do-server-nagios}/nagios</strong> e digite o nome de usuário como <strong>nagiosadmin</strong> e sua senha que criamos nos passos anteriores.</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/192.168.1.103-nagios-Google-Chrome_001.jpg" alt=""></p>

<p>Aqui esta um exemplo da página de administração do Nagios:</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_002.jpg" alt=""></p>

<p>Clique na seção de <strong>"Hosts"</strong> no painel esquerdo. Você verá os hosts que estão sendo monitorados pelo servidor Nagios. Nós ainda não adicionamos nenhum host. Então apenas o localhost será exibido na lista.</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_003.jpg" alt=""></p>

<p>Clique no <em>localhost</em> para exibir mais detalhes</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_004.jpg" alt=""></p>

<p>É isso, instalamos e configuramos o Nagios!</p>

<h2>
<a id="adicionar-clintes-monitorados-ao-servidor-nagios" class="anchor" href="#adicionar-clintes-monitorados-ao-servidor-nagios" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adicionar clintes monitorados ao servidor Nagios</h2>

<p>Agora, vamos adicionar alguns clientes para serem monitorados pelo servidor Nagios.
Para isso precisamos instalar o <strong>nrpe</strong> e o <strong>nagios-plugin</strong> em nossos alvos de monitoramento.</p>

<h3>
<a id="no-debianlinux" class="anchor" href="#no-debianlinux" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>No Debian/Linux</h3>

<pre><code>apt-get update
apt-get install nagios-nrpe-server nagios-plugins
</code></pre>

<p>Configure os alvos de monitoramento, edite o arquivo <strong>/etc/nagios/nrpe.cfg</strong>,</p>

<pre><code>nano /etc/nagios/nrpe.cfg
</code></pre>

<p>Adicione o ip do seu servidor Nagios:</p>

<pre><code>[...]
## Encontre as seguintes linhas e adicione o ip do servidor Nagios ##
allowed_hosts=127.0.0.1 192.168.1.103
[...]
</code></pre>

<p>Inicie o serviço nrpe:</p>

<pre><code>/etc/init.d/nagios-nrpe-server restart
</code></pre>

<p>Agora, <strong>volte ao Nagios server</strong> e adicione os clientes (no arquivo de configuração).
Para tal, Edite o arquivo <strong>"/usr/local/nagios/etc/nagios.cfg"</strong>,</p>

<pre><code>nano /usr/local/nagios/etc/nagios.cfg
</code></pre>

<p>e remova o comentário da seguinte linha</p>

<pre><code>## Encontre e remova o comentário da seguinte linha ##
cfg_dir=/usr/local/nagios/etc/servers
</code></pre>

<p>Crie um diretório chamado <strong>"servers"</strong> dentro da pasta <strong>"/usr/local/nagios/etc/"</strong></p>

<pre><code>mkdir /usr/local/nagios/etc/servers
</code></pre>

<p>Crie um arquivo de configuração para monitorar o cliente:</p>

<pre><code>nano /usr/local/nagios/etc/servers/clients.cfg
</code></pre>

<p>Adicione as seguintes linhas:</p>

<pre><code>define host{

use                             linux-server
host_name                       server.unixmen.local
alias                           server
address                         192.168.1.104 ##informe o ip do seu client aqui
max_check_attempts              5
check_period                    24x7
notification_interval           30
notification_period             24x7

}  
</code></pre>

<p>Nesse caso, <strong>192.168.1.104</strong> é o ip do meu cliente Nagios e server.unixmen.local é o hostname.</p>

<p>Por fim, reinicie o serviço do nagios.</p>

<pre><code>service nagios restart
</code></pre>

<p>Aguarde alguns segundos e atualize a página administrativa do nagios no browser, e etão navegue até a seção de <strong>hosts</strong> no painel da esquerda. Agora, você verá o cliente que foi adicionado recentemente. Click nele para visualizer se tem alguma coisa errada ou algum alerta.</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_005.jpg" alt=""> </p>

<p>Click no cliente para visualizar informações detalhadas:</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_006.jpg" alt=""></p>

<p>Da mesma forma, você pode definir mais clientes criando um arquivos de configuração separados para cada cliente. </p>

<h3>
<a id="definindo-serviço" class="anchor" href="#definindo-servi%C3%A7o" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Definindo serviço</h3>

<p>Acabamos de definir um cliente para ser monitorado. Agora, vamos adicionar alguns serviços do cliente. Por exemplo, para monitor o serviço <strong>ssh</strong>, adicione as seguintes linhas no arquivo <strong>"/usr/local/nagios/etc/servers/clients.cfg"</strong>.</p>

<pre><code>nano /usr/local/nagios/etc/services/clients.cfg
</code></pre>

<p>Adicione as seguintes linhas:</p>

<pre><code>[...]
##ADICIONE AS LINHAS ABAIXO \/
define service {
    use                             generic-service
    host_name                       server.unixmen.local
    service_description             SSH
    check_command                   check_ssh
    notifications_enabled           0
}
</code></pre>

<p>Salve e feche o arquivo. Reinicie o Nagios.</p>

<pre><code>service nagios restart
</code></pre>

<p>Aguarde alguns segundos (<strong>90</strong> segundos por padrão), e verifique pelos serviços adicionados (exemplo: ssh) na interface web do nagios. Navegue para a seção <strong>Services</strong> no menu esquerdo, você verá o serviço <strong>ssh</strong> na lista.</p>

<p><img src="http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_007.jpg" alt=""></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/rafaelbm/Nagios">Nagios</a> is maintained by <a href="https://github.com/rafaelbm">rafaelbm</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
