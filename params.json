{
  "name": "Nagios",
  "tagline": "Trabalho para o tio Lu sobre o Nagios",
  "body": "# Instalando Nagios 4.1.1 #\r\n\r\nTutorial baseado no seguinte [post](http://www.unixmen.com/how-to-install-nagios-core-4-1-1-in-ubuntu-15-10/).\r\n\r\nOutros posts que foram úteis:  \r\n\r\n- [https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/eventhandlers.html](https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/eventhandlers.html)\r\n- [https://thiagolucas.wordpress.com/2014/03/28/nagios-debian-instalacao-detalhada/](https://thiagolucas.wordpress.com/2014/03/28/nagios-debian-instalacao-detalhada/)\r\n\r\n> Nagios é um sistema utilizado para monitorar a infraestrutura de rede. Usando Nagios, podemos monitorar servidores, switches, aplicações e serviços etc. Alertar o administrador do sistema quando algo der errado e também alertar quando esses erros forem corrigidos.\r\n\r\n## Principais funcionalidades ###\r\n\r\n- Monitoração total da infraestrutura de TI\r\n- Notificações quando problemas surgirem\r\n- Compartilhar dados de disponibilidade com os stakeholders\r\n- Detectar violações de segurança\r\n- Redução de downtime dos ativos\r\n\r\n## Pré-requisitos ###\r\n\r\n**Para facilitar os passos a seguir execute-os em modo *root*.**\r\n\r\nAtualizar o servidor\r\n  \r\n\tapt-get update  \r\n\tapt-get upgrade \r\n\r\nInstale as dependências do nagios\r\n\r\n\tapt-get install libgd2-xpm-dev libsnmp-perl libssl-dev openssl build-essential apache2 libapache2-mod-php5 unzip\r\n\r\nCrie um novo usuário do ***nagios***\r\n\r\n\tuseradd -m nagios\r\n\tpasswd nagios\r\n\r\nCrie um novo grupo de usuários ***nagcmd*** para permitir que comandos externos sejam enviados através da interface web. Adicione o usuário nagios e o usuário do apache ao grupo.\r\n\r\n\tgroupadd nagcmd\r\n\tusermod -a -G nagcmd nagios\r\n\tusermod -a -G nagcmd www-data\t\r\n\r\n\r\n## Baixar o Nagios e Plugins ##\r\n\r\nCrie um diretório para armazenar os downloads\r\n\r\n\tmkdir /usr/src/nagios\r\n\tcd /usr/src/nagios\r\n\r\nVá para a página do [Nagios](https://www.nagios.org/downloads/nagios-core/thanks/?t=1466426447) para obter a versão mais recente, a versão mais recente durante a escrita desse documento é a 4.1.1\r\n\r\n\twget https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.1.1.tar.gz\r\n\r\nE baixe também os [plugins](https://www.nagios.org/downloads/nagios-plugins/) do nagios\r\n\r\n\twget http://www.nagios-plugins.org/download/nagios-plugins-2.1.1.tar.gz\r\n\r\nCaso algum erro relacionado a certificados ocorra durante a executação do **wget**, execute utilizando o parâmetro **--no-check-certificate**\r\n\r\n\twget --no-check-certificate link\r\n\r\n## Instalar Nagios e Plugins ##\r\n\r\n### Instalar Nagios ###\r\n\r\nVa até a pasta onde baixou o nagios e extraia os arquivos:\r\n\r\n\ttar xzf nagios-4.1.1.tar.gz\r\n\r\nAcesse o diretório extraído:\r\n\r\n\tcd nagios-4.1.1/\r\n\r\n\r\nExecute os seguintes comandos um a um para compilar e instalar o nagios.\r\n\r\n\t./configure --with-command-group=nagcmd\r\n\tmake all\r\n\tmake install\r\n\tmake install-init\r\n\tmake install-config\r\n\tmake install-commandmode\r\n\r\n### Instalar a interface web do Nagios ###\r\n\r\nExecute o seguinte comando para compilar e instalar a interface web.\r\n\r\n\tmake install-webconf\r\n\r\nCaso o seguinte erro ocorra: \r\n> /usr/bin/install -c -m 644 sample-config/httpd.conf /etc/httpd/conf.d/nagios.conf\r\n> /usr/bin/install: cannot create regular file ‘/etc/httpd/conf.d/nagios.conf’: No such file or directory\r\n> Makefile:296: recipe for target 'install-webconf' failed\r\n> make: *** [install-webconf] Error 1\r\n\r\nA mensagem de erro acima descreve que o nagios está tentando criar o arquivo **nagios.conf** dentro do diretório **/etc/httpd.conf/**. Mas em sistemas derivados do Ubuntu o **nagios.conf** deve ser colocado no diretório /etc/apache2/sites-enabled/\r\n\r\nPara tal, execute o seguinte comando no lugar do **make install-webconf**.\r\n\r\n\t/usr/bin/install -c -m 644 sample-config/httpd.conf /etc/apache2/sites-enabled/nagios.conf\r\n\r\nVerifique se o **nagios.conf** está no diretório /etc/apache2/sites-enabled.\r\n\r\n\tls -l /etc/apache2/sites-enabled/\r\n\r\nO output desse comando deve ser semelhante a este:\r\n\r\n>total 4  \r\nlrwxrwxrwx 1 root root 35 Nov 28 16:49 000-default.conf -../sites-available/000-default.conf   \r\n-rw-r--r-- 1 root root 1679 Nov 28 17:02 nagios.conf \r\n\r\nCrie uma conta ***nagiosadmin*** para a autenticação na interface web do Nagios. **Lembre-se da senha que você definir**, ela será utilizada para logar na interface web.\r\n\r\n\thtpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin\r\n\r\nReinicie o Apache para que as novas configurações tenham efeito.\r\n\r\n\tservice apache2 restart\r\n\r\n### Instalar Nagios Plugins ###\r\n\r\nVa para o diretório (provavelmente o **/usr/src/nagios**) onde você baixou o nagios plugins, e extraia os arquivos \r\n\r\n\ttar xzf nagios-plugins-2.1.1.tar.gz\r\n\r\nAcesse o diretório extraído:\r\n\r\n\tcd nagios-plugins-2.1.1/\r\n\r\nExecute os seguintes comandos um a um para compilar e instalar.\r\n\r\n\t./configure --with-nagios-user=nagios --with-nagios-group=nagios\r\n\tmake\r\n\tmake install\r\n\r\n## Configurar o nagios ##\r\n\r\nOs arquivos com configurações de exemplo do Nagios estão localizados no diretório **/usr/local/nagios/etc**.Esses arquivos de exemplo devem funcionar bem para uma introdução ao Nagios. No entando, se você quiser, precisará colocar o seu ID e e-mail para receber alertas.\r\n\r\nPara tal, edite o arquivo de configuração **/usr/local/nagios/etc/objects/contacts.cfg** e altere o e-mail associado ao contato *nagiosadmin*. Este e-mail será onde os alertas serão enviados\r\n\r\n\tnano /usr/local/nagios/etc/objects/contacts.cfg\r\n\r\nEncontre a linha a seguir e informe o seu e-mail:\r\n \r\n\t [...]  \r\n\t define contact {  \r\n\t contact_name                    nagiosadmin             ; Short name of user  \r\n\t use                             generic-contact         ; Inherit default values from generic-contact template (defined above)    \r\n\t alias                           Nagios Admin            ; Full name of user   \r\n\t email                           seuemailaqui.com    \t ; <<CHANGE THIS TO YOUR EMAIL ADDRESS\r\n\t }  \r\n\t [...]\r\n\r\nSalve e feche o arquivo.\r\n\r\n<!--\r\nEntão, edite o arquivo **/etc/apache2/sites-enabled/nagios-conf**\r\n\r\n\tnano /etc/apache2/sites-enabled/nagios.conf\r\n\r\nE edite as seguintes linhas se você desejar acessar o nagios console administrativo de uma determinada\r\n faixa de IP.\r\n\r\n\t[...]\r\n\t## Comment the following lines \r\n\t#   Order allow,deny\r\n\t#   Allow from all\r\n\t\r\n\t## Uncomment and Change lines as shown below\r\n\tOrder deny,allow\r\n\tDeny from all\r\n\tAllow from 127.0.0.1 192.168.1.0/24 #seu ip vai aqui\r\n\t[...]\r\n-->\r\n\r\nHabilitar os módulos do Apache e reconfiguração e cgi\r\n\r\n\ta2enmod rewrite\r\n\ta2enmod cgi\r\n\r\nReiniciar o serviço Apache\r\n\t\r\n\tservice apache2 restart\r\n\r\nVerifique se o arquivo **nagios.cfg** contém algum erro de sintaxe:\r\n\r\n\t/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg\r\n\r\nCaso o comando acima não tenha apontado erros, podemos iniciar o serviço nagios: \r\n\r\n\tservice nagios start\r\n\r\nNas versões mais recentes do Ubuntu/Debian é possível que o comando acima lance o seguinte erro:\r\n\r\n\tFailed to start nagios.service: Unit nagios.service failed to load: No such file or directory.\r\n\r\nPara corrigir esse erro é necessário copiar o arquivo **/etc/init.d/skeleton** para **/etc/init.d/nagios** utilizando o seguinte comando:\r\n\r\n\tcp /etc/init.d/skeleton /etc/init.d/nagios\r\n\r\nEdite o arquivo **/etc/init.d/nagios**\r\n\r\n\tnano /etc/init.d/nagios\r\n\r\nAdicione as seguintes linhas:\r\n\r\n\tDESC=\"Nagios\"\r\n\tNAME=nagios\r\n\tDAEMON=/usr/local/nagios/bin/$NAME\r\n\tDAEMON_ARGS=\"-d /usr/local/nagios/etc/nagios.cfg\"\r\n\tPIDFILE=/usr/local/nagios/var/$NAME.lock\r\n\r\nSalve e feche o arquivo.\r\n\r\nÉ necessário alterar as permissões do arquivo.\r\n\r\n\tchmod +x /etc/init.d/nagios\r\n\r\nAgora é possível iniciar o serviço nagios utilizando o comando:\r\n\r\n\t/etc/init.d/nagios start \r\n\r\n## Acessar a interface web do Nagios ##\r\n\r\nAbra seu navegador da web e navegue até **http://{ip-do-server-nagios}/nagios** e digite o nome de usuário como **nagiosadmin** e sua senha que criamos nos passos anteriores.\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/192.168.1.103-nagios-Google-Chrome_001.jpg)\r\n\r\nAqui esta um exemplo da página de administração do Nagios:\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_002.jpg)\r\n\r\nClique na seção de **\"Hosts\"** no painel esquerdo. Você verá os hosts que estão sendo monitorados pelo servidor Nagios. Nós ainda não adicionamos nenhum host. Então apenas o localhost será exibido na lista.\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_003.jpg)\r\n\r\nClique no *localhost* para exibir mais detalhes\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_004.jpg)\r\n\r\n\r\nÉ isso, instalamos e configuramos o Nagios!\r\n\r\n## Adicionar clientes monitorados ao servidor Nagios ##\r\n\r\nAgora, vamos adicionar alguns clientes para serem monitorados pelo servidor Nagios.\r\nPara isso precisamos instalar o **nrpe** e o **nagios-plugin** em nossos alvos de monitoramento.\r\n\r\n### No Debian/Linux ###\r\n\r\n\tapt-get update\r\n\tapt-get install nagios-nrpe-server nagios-plugins\r\n\r\nConfigure os alvos de monitoramento, edite o arquivo **/etc/nagios/nrpe.cfg**,\r\n\r\n\tnano /etc/nagios/nrpe.cfg\r\n\r\nAdicione o ip do seu servidor Nagios:\r\n\r\n\t[...]\r\n\t## Encontre as seguintes linhas e adicione o ip do servidor Nagios ##\r\n\tallowed_hosts=127.0.0.1 192.168.1.103\r\n\t[...]\r\n\t\r\nInicie o serviço nrpe:\r\n\r\n\t/etc/init.d/nagios-nrpe-server restart\r\n\r\nAgora, **volte ao Nagios server** e adicione os clientes (no arquivo de configuração).\r\nPara tal, Edite o arquivo **\"/usr/local/nagios/etc/nagios.cfg\"**,\r\n\r\n\tnano /usr/local/nagios/etc/nagios.cfg\r\n\r\ne remova o comentário da seguinte linha\r\n\r\n\t## Encontre e remova o comentário da seguinte linha ##\r\n\tcfg_dir=/usr/local/nagios/etc/servers\r\n\r\nCrie um diretório chamado **\"servers\"** dentro da pasta **\"/usr/local/nagios/etc/\"**\r\n\r\n\tmkdir /usr/local/nagios/etc/servers\r\n\r\nCrie um arquivo de configuração para monitorar o cliente:\r\n\r\n\tnano /usr/local/nagios/etc/servers/clients.cfg\r\n\r\nAdicione as seguintes linhas:\r\n\r\n\tdefine host{\r\n\t\r\n\tuse                             linux-server\r\n\thost_name                       server.unixmen.local\r\n\talias                           server\r\n\taddress                         192.168.1.104 ##informe o ip do seu client aqui\r\n\tmax_check_attempts              5\r\n\tcheck_period                    24x7\r\n\tnotification_interval           30\r\n\tnotification_period             24x7\r\n\t\r\n\t}  \r\n\r\nNesse caso, **192.168.1.104** é o ip do meu cliente Nagios e server.unixmen.local é o hostname.\r\n\r\nPor fim, reinicie o serviço do nagios.\r\n\r\n\t/etc/init.d/nagios restart\r\n\r\nAguarde alguns segundos e atualize a página administrativa do nagios no browser, e então navegue até a seção de **hosts** no painel da esquerda. Agora, você verá o cliente que foi adicionado recentemente. Click nele para visualizar se tem alguma coisa errada ou algum alerta.\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_005.jpg) \r\n\r\nClick no cliente para visualizar informações detalhadas:\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_006.jpg)\r\n\r\nDa mesma forma, você pode definir mais clientes criando um arquivos de configuração separados para cada cliente. \r\n\r\n### Definindo serviço ###\r\n\r\nAcabamos de definir um cliente para ser monitorado. Agora, vamos adicionar alguns serviços do cliente. Por exemplo, para monitor o serviço **ssh**, adicione as seguintes linhas no arquivo **\"/usr/local/nagios/etc/servers/clients.cfg\"**.\r\n\r\n\tnano /usr/local/nagios/etc/services/clients.cfg\r\n\r\nAdicione as seguintes linhas:\r\n\t\r\n\r\n\t[...]\r\n\t##ADICIONE AS LINHAS ABAIXO \\/\r\n\tdefine service {\r\n        use                             generic-service\r\n        host_name                       server.unixmen.local\r\n        service_description             SSH\r\n        check_command                   check_ssh\r\n        notifications_enabled           0\r\n    }\r\n\r\n Salve e feche o arquivo. Reinicie o Nagios.\r\n\r\n\t/etc/init.d/nagios restart\r\n\r\nAguarde alguns segundos (**90** segundos por padrão), e verifique pelos serviços adicionados (exemplo: ssh) na interface web do nagios. Navegue para a seção **Services** no menu esquerdo, você verá o serviço **ssh** na lista.\r\n\r\n![](http://www.unixmen.com/wp-content/uploads/2015/11/Nagios-Core-Google-Chrome_007.jpg)\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}